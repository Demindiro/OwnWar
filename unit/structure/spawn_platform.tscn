[gd_scene load_steps=9 format=2]

[ext_resource path="res://unit/structure/platform.obj" type="ArrayMesh" id=1]
[ext_resource path="res://addons/arrow.png" type="Texture" id=2]

[sub_resource type="GDScript" id=1]
script/source = "extends Unit


signal spawned(unit)
# Thank cyclic PackedScene errors for this
export(PackedScene) var worker = load(\"res://unit/worker/drone.tscn\")
var material = 0 setget set_material
# warning-ignore:unused_class_variable
var max_material setget , get_max_material
var queued_vehicle = null
var queued_vehicle_name


func _ready():
	unit_name = \"spawn_platform\"
	set_material(material)
	$IndicatorVehicle.material_override = $IndicatorVehicle.material_override.duplicate()
	$IndicatorVehicle.material_override.albedo_color = Color.green
	

func _notification(notification):
	match notification:
		NOTIFICATION_PREDELETE:
			if queued_vehicle != null:
				queued_vehicle.free()


func get_info():
	var info = .get_info()
	info[\"Material\"] = str(material) + \" / \" + str(get_max_material())
	if queued_vehicle != null:
		info[\"Queued\"] = queued_vehicle_name
	return info


func get_actions():
	var actions = [[\"Spawn Drone\", Action.INPUT_NONE, \"spawn_worker\", []]]
	var directory = Directory.new()
	var err = directory.open(Global.DIRECTORY_USER_VEHICLES)
	if err == OK:
		directory.list_dir_begin(true)
		var file_name = directory.get_next()
		while file_name != \"\":
			if not directory.current_is_dir() and \\
					file_name.ends_with(Global.FILE_EXTENSION):
				var action_name = \"Spawn \" + Vehicle.path_to_name(file_name)
				var path = directory.get_current_dir() + '/' + file_name
				actions.append([action_name, 0, \"spawn_vehicle\", [path]])
			file_name = directory.get_next()
	else:
		Global.error(err)
	return actions


func spawn_worker(_flags):
	if queued_vehicle != null:
		queued_vehicle.free()
	queued_vehicle = worker.instance()
	$IndicatorVehicle.material_override.albedo_color = Color.orange
	queued_vehicle.global_transform = global_transform
	queued_vehicle.translate(Vector3.UP * 5)
	queued_vehicle.rotate_y(PI)
	queued_vehicle_name = \"Worker Drone\"
	return queued_vehicle


func spawn_vehicle(_flags, path):
	if queued_vehicle != null:
		queued_vehicle.free()
	queued_vehicle = load(Global.SCENE_VEHICLE).instance()
	var err = queued_vehicle.load_from_file(path)
	if err != OK:
		Global.error(\"Failed to spawn vehicle from '%s'\" % path, err)
		queued_vehicle.free()
		queued_vehicle = null
		$IndicatorVehicle.material_override.albedo_color = Color.red
	else:
		queued_vehicle.global_transform = global_transform
		queued_vehicle.translate(Vector3.UP * 5)
		queued_vehicle.rotate_y(PI)
		$IndicatorVehicle.material_override.albedo_color = Color.orange
		queued_vehicle_name = Vehicle.path_to_name(path.get_file())
	return queued_vehicle


func put_material(p_material):
	if queued_vehicle == null:
		return p_material
	self.material += p_material
	if material >= queued_vehicle.get_cost():
		game_master.add_unit(team, queued_vehicle)
		emit_signal(\"spawned\", queued_vehicle)
		var remainder = material - queued_vehicle.get_cost()
		self.material = 0
		queued_vehicle = null
		$IndicatorVehicle.material_override.albedo_color = Color.green
		return remainder
	return 0


func set_material(p_material):
	assert(0 <= p_material)
	material = p_material
	if queued_vehicle == null:
		$IndicatorMaterial.scale.z = 0 if material == 0 else 1
	else:
		$IndicatorMaterial.scale.z = clamp(float(material) / queued_vehicle.get_cost(), 0, 1)


func get_max_material():
	return 0 if queued_vehicle == null else queued_vehicle.get_cost()
"

[sub_resource type="BoxShape" id=2]
extents = Vector3( 7, 1, 8 )

[sub_resource type="BoxShape" id=3]
extents = Vector3( 7, 1.077, 2.692 )

[sub_resource type="QuadMesh" id=4]

[sub_resource type="SpatialMaterial" id=5]
albedo_color = Color( 0, 0.905882, 1, 1 )

[sub_resource type="SpatialMaterial" id=6]
albedo_color = Color( 0, 0, 0, 0.392157 )

[node name="SpawnPlatform" type="StaticBody"]
script = SubResource( 1 )
max_health = 2000
unit_name = "spawn_platform"

[node name="MeshInstance" type="MeshInstance" parent="."]
mesh = ExtResource( 1 )
material/0 = null

[node name="Sprite3D" type="Sprite3D" parent="."]
transform = Transform( 1.91069e-15, 1, -4.37114e-08, 4.37114e-08, -4.37114e-08, -1, -1, 0, -4.37114e-08, 0, 1.01, 0 )
texture = ExtResource( 2 )

[node name="CollisionShape" type="CollisionShape" parent="."]
shape = SubResource( 2 )

[node name="CollisionShape2" type="CollisionShape" parent="."]
transform = Transform( 1, 0, 0, 0, 0.928479, 0.371384, 0, -0.371384, 0.928479, 0, -1, -10.1 )
shape = SubResource( 3 )

[node name="IndicatorMaterial" type="Spatial" parent="."]
transform = Transform( -4.37114e-08, 0, -1, 0, 1, 0, 1, 0, -4.37114e-08, 6.9, 1.01, 7.4 )

[node name="MeshInstance" type="MeshInstance" parent="IndicatorMaterial"]
transform = Transform( 1, 0, 0, 0, -5.55135e-07, 1, 0, -12.7, -4.37114e-08, 0, 0, 6.35 )
mesh = SubResource( 4 )
material/0 = SubResource( 5 )

[node name="IndicatorVehicle" type="MeshInstance" parent="."]
transform = Transform( -4.37114e-08, 1, 4.37114e-08, 0, -4.37114e-08, 1, 1, 4.37114e-08, 1.91069e-15, -6.4, 1.01, 7.4 )
material_override = SubResource( 6 )
mesh = SubResource( 4 )
material/0 = null
