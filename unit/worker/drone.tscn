[gd_scene load_steps=7 format=2]

[ext_resource path="res://unit/structure/drill_ghost.tscn" type="PackedScene" id=1]

[sub_resource type="GDScript" id=1]
script/source = "extends Unit


const SPEED = 20
export(PackedScene) var drill_ghost
export(int) var max_materials = 100
var materials = 0
var ghost = null
var last_build_frame = 0
onready var waypoint = translation
onready var rotors = [
		$ArmLF/Rotor,
		$ArmRF/Rotor,
		$ArmLB/Rotor,
		$ArmRB/Rotor,
	]


func _process(delta):
	for rotor in rotors:
		rotor.rotate_object_local(Vector3.UP, delta * 50)
		
		
func _physics_process(delta):
	var distance = waypoint - translation
	var distance_xz = Vector3(distance.x, 0, distance.z)
	var distance_xz_length2 = distance_xz.length_squared()
	var speed = SPEED if distance_xz_length2 > SPEED * SPEED * delta * delta else \\
			sqrt(distance_xz_length2) / delta
	var velocity_direction = distance_xz.normalized()
	var height = translation.y - $RayCast.get_collision_point().y if \\
			$RayCast.is_colliding() else 5
	if height < 1:
		velocity_direction = (velocity_direction + Vector3.UP).normalized()
	elif height > 4:
		velocity_direction = (velocity_direction + Vector3.DOWN).normalized()
	if distance_xz_length2 > 1e-5:
		$\".\".move_and_slide(velocity_direction * speed, Vector3.UP,
				false, 4, PI / 4, false)

	if ghost != null:
		if last_build_frame + Engine.iterations_per_second < Engine.get_physics_frames() and \\
				translation.distance_squared_to(ghost.translation) <= 9:
			var material = game_master.take_material(team, 1)
			material = ghost.add_build_progress(material)
			game_master.add_material(team, material)
			last_build_frame = Engine.get_physics_frames()


func get_actions():
	return [
			['Set waypoint', Action.INPUT_COORDINATE, 'set_waypoint', []],
			[\"Build drill\", Action.INPUT_COORDINATE, \"build_drill\", []],
		]


func set_waypoint(coordinate):
	waypoint = coordinate


func build_drill(coordinate):
	var closest_ore = null
	var max_distance = 3.0
	for ore in game_master.ores:
		var distance = (ore.translation - coordinate).length()
		if ore.drill == null and distance < max_distance:
			closest_ore = ore
			max_distance = distance
	if closest_ore != null:
		ghost = drill_ghost.instance()
		ghost.translation = closest_ore.translation + Vector3.UP * 1.4
		ghost.init_arguments = [closest_ore]
		ghost.connect(\"built\", self, \"_on_built\")
		game_master.add_child(ghost)
		set_waypoint(ghost.translation)


func _on_built(_structure):
	ghost = null
"

[sub_resource type="CubeMesh" id=2]
size = Vector3( 0.8, 0.3, 1 )

[sub_resource type="CubeMesh" id=3]
size = Vector3( 0.1, 0.1, 1.5 )

[sub_resource type="CubeMesh" id=4]
size = Vector3( 1.8, 0.01, 0.05 )

[sub_resource type="BoxShape" id=5]
extents = Vector3( 1.625, 0.125, 1.625 )

[node name="Drone" type="KinematicBody"]
script = SubResource( 1 )
unit_name = "worker"
drill_ghost = ExtResource( 1 )

[node name="Body" type="MeshInstance" parent="."]
mesh = SubResource( 2 )
material/0 = null
__meta__ = {
"_editor_description_": ""
}

[node name="ArmLF" type="MeshInstance" parent="."]
transform = Transform( 0.707107, 0, 0.707107, 0, 1, 0, -0.707107, 0, 0.707107, 0.795495, 0, 0.795495 )
mesh = SubResource( 3 )
material/0 = null
__meta__ = {
"_editor_description_": ""
}

[node name="Rotor" type="MeshInstance" parent="ArmLF"]
transform = Transform( 1, -2.38419e-07, 0, 2.38419e-07, 1, 0, 0, 0, 1, 0, 0.06, 0.675 )
mesh = SubResource( 4 )
material/0 = null

[node name="ArmRF" type="MeshInstance" parent="."]
transform = Transform( 0.707107, 0, -0.707107, 0, 1, 0, 0.707107, 0, 0.707107, -0.795495, 0, 0.795495 )
mesh = SubResource( 3 )
material/0 = null
__meta__ = {
"_editor_description_": ""
}

[node name="Rotor" type="MeshInstance" parent="ArmRF"]
transform = Transform( -1, 1.50996e-07, 0, -1.50996e-07, -1, 0, 0, 0, 1, 0, 0.06, 0.675 )
mesh = SubResource( 4 )
material/0 = null

[node name="ArmLB" type="MeshInstance" parent="."]
transform = Transform( -0.707107, 0, 0.707106, 0, 1, 0, -0.707106, 0, -0.707107, 0.795495, 0, -0.795495 )
mesh = SubResource( 3 )
material/0 = null
__meta__ = {
"_editor_description_": ""
}

[node name="Rotor" type="MeshInstance" parent="ArmLB"]
transform = Transform( -1, 1.50996e-07, 0, -1.50996e-07, -1, 0, 0, 7.10543e-15, 1, -5.96046e-08, 0.06, 0.675 )
mesh = SubResource( 4 )
material/0 = null

[node name="ArmRB" type="MeshInstance" parent="."]
transform = Transform( -0.707107, 0, -0.707107, 0, 1, 0, 0.707107, 0, -0.707107, -0.795495, 0, -0.795495 )
mesh = SubResource( 3 )
material/0 = null
__meta__ = {
"_editor_description_": ""
}

[node name="Rotor" type="MeshInstance" parent="ArmRB"]
transform = Transform( 1, -2.38419e-07, 0, 2.38419e-07, 1, 0, 0, 0, 1, 0, 0.06, 0.675 )
mesh = SubResource( 4 )
material/0 = null
__meta__ = {
"_editor_description_": ""
}

[node name="CollisionShape" type="CollisionShape" parent="."]
shape = SubResource( 5 )

[node name="RayCast" type="RayCast" parent="."]
enabled = true
cast_to = Vector3( 0, -5, 0 )
